---
title: 添加新主机
category: Operations Guide
---

## How to Add new Hosts for Ambari

### 添加hosts
```
10.60.16.88  whd20.oa.com whd20.oa.com. cvm-da-datasvr-whd20
10.60.16.73  whd21.oa.com whd21.oa.com. cvm-da-datasvr-whd21
10.60.16.159 whd22.oa.com whd22.oa.com. cvm-da-datasvr-whd22
```

### 添加互信
```
ssh-copy-id -i ~/.ssh/id_rsa.pub root@10.60.16.44
```

### 添加客户端主机hosts

```
10.60.16.168 cvm-da-datasvr-whd1.hadoop.com cvm-da-datasvr-whd1
10.60.16.201 cvm-da-datasvr-whd2.hadoop.com cvm-da-datasvr-whd2
10.60.16.62  cvm-da-datasvr-whd3.hadoop.com cvm-da-datasvr-whd3
10.60.16.39  cvm-da-datasvr-whd4.hadoop.com cvm-da-datasvr-whd4
10.60.16.214 cvm-da-datasvr-whd5.hadoop.com cvm-da-datasvr-whd5
10.60.16.150 cvm-da-datasvr-whd6.hadoop.com cvm-da-datasvr-whd6
10.60.16.213 cvm-da-datasvr-whd7.hadoop.com cvm-da-datasvr-whd7

10.60.16.70 cvm-da-datasvr-hdapp1.hadoop.com  cvm-da-datasvr-hdapp1
10.60.144.16 cvm-da-datasvr-dataflow4.hadoop.com  cvm-da-datasvr-dataflow4
```

```
echo " " >> /etc/hosts
echo "10.60.16.44  cvm-da-datasvr-whd17.oa.com cvm-da-datasvr-whd17.oa.com. cvm-da-datasvr-whd17 " >> /etc/hosts
echo "10.60.16.100 cvm-da-datasvr-whd18.oa.com cvm-da-datasvr-whd18.oa.com. cvm-da-datasvr-whd18 " >> /etc/hosts
echo "10.60.16.178 cvm-da-datasvr-whd19.oa.com cvm-da-datasvr-whd19.oa.com. cvm-da-datasvr-whd19 " >> /etc/hosts
```
### 添加DNS 
把新增主机的域名配置到生产DNS中
```
10.60.16.88  whd20.oa.com
10.60.16.73  whd21.oa.com
10.60.16.159 whd22.oa.com
```
### 安装软件
```
yum install sssd sssd-ad krb5-workstation authconfig oddjob-mkhomedir -y
```

### 安装jce包
```
unzip -o -j -q jce_policy-8.zip -d $JAVA_HOME/jre/lib/security
或
unzip -o -j -q jce_policy-8.zip -d /usr/local/java/jre/lib/security
```
### 拷贝msyql的驱动到对应主机
```
scp /usr/share/java/mysql-connector-java.jar cvm-da-datasvr-whd19:/usr/share/java/
```
注：如果不拷贝，sqoop等会报错

### 开始界面添加
省略

## 更改参数配置
```
vim /etc/ambari-agent/conf/ambari-agent.ini

[security]
force_https_protocol=PROTOCOL_TLSv1_2
```

## 运行hadoop.py
```
#!/usr/bin/env python
# coding=utf-8

import sys
import os
import os.path
import stat
import fileinput
import re
import subprocess as sbp


def install_packages():
    install_pkgs_cmd = "yum install sssd sssd-ad krb5-workstation authconfig oddjob-mkhomedir -y"
    sbp.call(install_pkgs_cmd, shell=True)


def boot_dep_services():
    boot_messagebus_cmd = "service messagebus restart && chkconfig messagebus on"
    sbp.call(boot_messagebus_cmd, shell=True)
    boot_messagebus_cmd = "systemctl restart systemd-logind"
    sbp.call(boot_messagebus_cmd, shell=True)


def config_hosts(host, ip):
    hosts_path = "/etc/hosts"
    domain_name = host.lower()
    record = """{ip}  {domain_name}""".format(ip=ip, domain_name=domain_name)
    resovled = False
    for line in fileinput.input(hosts_path, inplace=True):
        if domain_name in line:
            resovled = True
            line = record + "\n"
        sys.stdout.write(line)

    if not resovled:
        with open(hosts_path, "a") as fh:
            fh.write("\n" + record + "\n")


def config_krb5(krb5_host, krb5_realm):
    krb5_conf_template= """# generated by jessetong
        |
        | [logging]
        |   default = FILE:/var/log/krb5libs.log
        |   kdc = FILE:/var/log/krb5kdc.log
        |   admin_server = FILE:/var/log/kadmind.log
        |
        | [libdefaults]
        |   default_realm = {realm_name}
        |   dns_lookup_realm = false
        |   dns_lookup_kdc = false
        |   ticket_lifetime = 24h
        |   renew_lifetime = 7d
        |   forwardable = true
        |
        | [realms]
        |   {realm_name} = {{
        |     kdc = {krb5_host}
        |     admin_server = {krb5_host}
        |   }}
        |
        | [domain_realm]
        |   .{domain_name} = {realm_name}
        |   {domain_name}  = {realm_name}
    """
    krb5_conf = krb5_conf_template.format(krb5_host=krb5_host,
                                          domain_name=krb5_realm.lower(),
                                          realm_name=krb5_realm.upper())

    indent_pattern = re.compile(r"[ \t]*\|[ \t]?")
    krb5_conf = indent_pattern.sub("", krb5_conf)

    krb5_conf_path = os.path.abspath("/etc/krb5.conf")
    krb5_conf_backup_path = os.path.dirname(krb5_conf_path) + "/krb5.conf_back"

    if os.path.exists(krb5_conf_path):
        os.rename(krb5_conf_path, krb5_conf_backup_path)
    with open(krb5_conf_path, "w") as fh:
        fh.write(krb5_conf)


def enable_auth_with_sssd():
    authconfig_cmd = "authconfig --enablesssdauth --enablesssd --enablemkhomedir --update"
    boot_oddjobd_cmd = "service oddjobd restart && chkconfig oddjobd on"
    sbp.call(authconfig_cmd, shell=True)
    sbp.call(boot_oddjobd_cmd, shell=True)


def config_sssd(sssd_domains):
    sssd_conf_header = """# generated by jessetong
        |
        | [sssd]
        |   config_file_version = 2
        |   domains = {domain_list}
        |   services = nss, pam, sudo, ssh
        |
        |
        | [nss]
        |   filter_users = root,ldap,named,avahi,haldaemon,dbus,radiusd,news,nscd
        |   filter_groups = root
    """.format(domain_list=", ".join(sssd_domains.keys()))

    sssd_conf_content = []
    for domain_name, doamin_attr in sssd_domains.items():
        content = """
            | [domain/{domain_name}]
            |   debug_level = 3
            |
            |   id_provider = ldap
            |   access_provider = ldap
            |   auth_provider = krb5
            |   chpass_provider = krb5
            |
            | # ldap_id_use_start_tls = false
            |   ldap_uri = {ldap_url}
            |   ldap_default_bind_dn = {ldap_default_bind_dn}
            |   ldap_default_authtok_type = password
            |   ldap_default_authtok = {ldap_default_authtok}
            |
            | # defines user/group schema type
            |   ldap_schema = ad
            |   ldap_user_search_base = {ldap_user_search_base}
            |   ldap_user_object_class = user
            |   ldap_user_name = sAMAccountName
            |
            | # Uncomment/adjust as needed if IMU is not used:
            |   full_name_format = %1$s
            |   override_homedir = /home/%u
            |   default_shell = /bin/bash
            |
            | # for SID-UID mapping
            |   ldap_id_mapping = True
            |
            | # for performance
            |   ldap_referrals = false
            |   cache_credentials = true
            |
            | # access controls
            |   ldap_access_order = expire
            |   ldap_account_expire_policy = ad
            |   ldap_force_upper_case_realm = true
            |
            |
            | # required
            |   krb5_realm = {krb5_realm}
            |   krb5_canonicalize = false
            |   krb5_server = {krb5_server}
            |   krb5_kpasswd = {krb5_kpasswd}
        """.format(domain_name=domain_name,
                   ldap_url=doamin_attr["ldap_url"],
                   ldap_default_bind_dn=doamin_attr["ldap_default_bind_dn"],
                   ldap_default_authtok=doamin_attr["ldap_default_authtok"],
                   ldap_user_search_base=doamin_attr["ldap_user_search_base"],
                   krb5_realm=doamin_attr["krb5_realm"],
                   krb5_server=doamin_attr["krb5_server"],
                   krb5_kpasswd=doamin_attr["krb5_kpasswd"])
        sssd_conf_content.append(content)
    sssd_conf = sssd_conf_header + "\n" + "\n".join(sssd_conf_content)

    indent_pattern = re.compile(r"[ \t]*\|[ \t]?")
    sssd_conf = indent_pattern.sub("", sssd_conf)

    sssd_conf_path = os.path.abspath("/etc/sssd/sssd.conf")
    sssd_conf_backup_path = os.path.dirname(sssd_conf_path) + "/sssd.conf_bak"

    if os.path.exists(sssd_conf_path):
        os.rename(sssd_conf_path, sssd_conf_backup_path)
    with open(sssd_conf_path, "w") as fh:
        fh.write(sssd_conf)
    os.chmod(sssd_conf_path, stat.S_IREAD | stat.S_IWRITE)

    boot_sssd_cmd = "service sssd restart && chkconfig sssd on"
    sbp.call(boot_sssd_cmd, shell=True)
    sbp.call("chown root:root /tmp", shell=True)


def verify_auth_conf():
    pass


def main():
    ad_ip = "10.95.10.122"
    ad_host = "CVM-OS-OA-ADDNS001"

    ldap_host = ad_host
    ldap_bind_dn = "CN=hadoop_ldap,OU=Service_Account,DC=wesure,DC=cn"
    ldap_authtok = "uHij%DvF"

    krb5_host = ad_host
    krb5_realm = "WESURE.CN"

    sssd_domains = {
        "staff.wesure.cn": {
            "ldap_url": "ldap://" + ldap_host,
            "ldap_default_bind_dn": ldap_bind_dn,
            "ldap_default_authtok": ldap_authtok,
            "ldap_user_search_base": "OU=微民保险,DC=wesure,DC=cn",
            "krb5_realm": krb5_realm.upper(),
            "krb5_server": krb5_host,
            "krb5_kpasswd": krb5_host
        },
        "users.hadoop.dc.wesure.cn": {
            "ldap_url": "ldap://" + ldap_host,
            "ldap_default_bind_dn": ldap_bind_dn,
            "ldap_default_authtok": ldap_authtok,
            "ldap_user_search_base": "OU=Service_Account,DC=wesure,DC=cn",
            "krb5_realm": krb5_realm.upper(),
            "krb5_server": krb5_host,
            "krb5_kpasswd": krb5_host
        }
    }

    #install_packages()
    boot_dep_services()
    #config_hosts(ad_host, ad_ip)
    #config_krb5(krb5_host, krb5_realm)
    enable_auth_with_sssd()
    config_sssd(sssd_domains)


if __name__ == '__main__':
    main()
```

### 备注：
1.需要hadoop_ldap密码
2.需要执行hadoop.py文件
3.防火墙，这边只能开出去的，其他机器访问这台的1019需要开(cms)
4.新节点要打通到196和197库的访问权限（sqoop会用到）


---

## 部署组件监控exporter

### 1.临时开放主机至proxy的网络权限（腾讯云上操作）
### 2.安装python 依赖包
```
export ALL_PROXY=http://10.60.0.115:8080/
pip install prometheus_client
pip install flask
pip install --upgrade pip
unset ALL_PROXY
```
### 3.上传proc_monitor到/usr/local/wesure/tools目录下
```
cd /usr/local/wesure/tools/proc_monitor
```
### 4.修改config.py配置文件 

vim config.py
```
#!/usr/bin/env python 
# -*- coding: utf-8 -*-
process_list = ['LogFeeder','NodeManager']

port_list = [
        { 'NodeManager1' : 8040 },
        { 'NodeManager2' : 7337 },
        { 'NodeManager3' : 8042 },
        { 'NodeManager4' : 45454},
        { 'NodeManager5' : 7447},
        { 'NodeManager6' : 13562},
]
```
### 5.添加supervisord配置文件 
cd /usr/local/wesure/supervisor/
vim proc_monitor.conf
```
[program:proc_monitor]
directory=/usr/local/wesure/tools/proc_monitor
command=/usr/bin/python /usr/local/wesure/tools/proc_monitor/proc_monitor.py
autorestart=true
stdout_logfile=/usr/local/wesure/supervisor/proc_monitor.log
stderr_logfile=/usr/local/wesure/supervisor/proc_monitor.err
```
### 6.用supervisorctl启动exporter程序
```
supervisorctl reread
supervisorctl update
supervisorctl status
```
